services:
  # GPU transcription server
  server:
    build:
      context: .
      dockerfile: docker/Dockerfile.gpu
    container_name: whisper-server
    ports:
      - "9090:9090"
    volumes:
      # Persistent model cache
      - whisper-models:/root/.cache/whisper-live
      - huggingface-models:/root/.cache/huggingface
      - openvino-models:/root/.cache/openvino_whisper_models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    command: python3 run_server.py --port 9090 --backend faster_whisper
    restart: unless-stopped
    networks:
      - whisper-network

  # Audio client with automatic Windows typing
  client:
    build:
      context: .
      dockerfile: docker/Dockerfile.client
    container_name: whisper-client
    depends_on:
      - server
    devices:
      - /dev/snd:/dev/snd
    group_add:
      - audio
    volumes:
      # WSL2 audio passthrough
      - /mnt/wslg:/mnt/wslg
      # Output logs
      - ./logs:/output
    environment:
      # Audio configuration
      - PULSE_SERVER=/mnt/wslg/PulseServer
      - ALSA_PCM_CARD=default
      - ALSA_PCM_DEVICE=0
      # Windows automation service URL (prefer host service)
      - WINDOWS_AUTOMATION_URL=http://host.docker.internal:8080
      # WhisperLive configuration (can be overridden)
      - VAD_THRESHOLD=${VAD_THRESHOLD:-0.5}
      - TRIGGER_WORDS=${TRIGGER_WORDS:-computer}
      - WSL_AUTO_TYPE=${WSL_AUTO_TYPE:-true}
      - WSL_TYPE_DELAY_MS=${WSL_TYPE_DELAY_MS:-0}
      - TEXT_STABILITY_DELAY=${TEXT_STABILITY_DELAY:-1.0}
    command: >
      python run_client.py 
        --server server 
        --port 9090 
        --model large-v3
        --vad_threshold ${VAD_THRESHOLD:-0.5}
        --trigger_words "${TRIGGER_WORDS:-computer}"
        --trigger_output_file /output/triggers.log
        --text_stability_delay ${TEXT_STABILITY_DELAY:-1.0}
        --wsl_auto_type
        --type_delay_ms ${WSL_TYPE_DELAY_MS:-0}
        --log_dir /output
    stdin_open: true
    tty: true
    restart: "no"  # Don't auto-restart client (interactive)
    networks:
      - whisper-network

volumes:
  whisper-models:
  huggingface-models:
  openvino-models:

networks:
  whisper-network:
    driver: bridge